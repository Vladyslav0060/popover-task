<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      rel="stylesheet"
      href="//code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css"
    />
    <link rel="stylesheet" href="./styles.css" />
    <script src="https://code.jquery.com/jquery-3.6.0.js"></script>
    <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <title>Document</title>
  </head>
  <body>
    <div class="wrapper-pie">
      <div class="pie">
        <h3 class="pie__title">Current Annual Return Breakdown</h3>
        <div class="chart-wrapper">
          <p class="sum-text-center"></p>
          <!-- <canvas id="chart-test"></canvas> -->
        </div>
        <div class="legend-container" id="legend-container"></div>
        <a href="#" class="toggle-count-value">
          Show Current Annual Return Breakdown<br />
          in <span class="current-annual-type">Percents</span>
        </a>
      </div>
    </div>

    <script>
      function initTooltips() {
        const id1 = "#tt1";
        const $elem1 = $(id1);
        const id2 = "#tt2";
        const $elem2 = $(id2);
        const id3 = "#tt3";
        const $elem3 = $(id3);
        const id4 = "#tt4";
        const $elem4 = $(id4);

        const elems = [
          {
            elem: $elem1,
            id: id1,
            content: `This is content of the tootlip ${id1}.`,
          },
          {
            elem: $elem2,
            id: id2,
            content: `This is content of the tootlip ${id2}.`,
          },
          {
            elem: $elem3,
            id: id3,
            content: `This is content of the tootlip ${id3}.`,
          },
          {
            elem: $elem4,
            id: id4,
            content: `This is content of the tootlip ${id4}.`,
          },
        ];

        function closeIfOpened(id) {
          const rest = elems.filter((item) => item.elem[0].id !== id);
          rest.forEach((item) => item.elem.tooltip("close"));
        }

        elems.forEach((item) => {
          item.elem.on("mouseenter", function (e) {
            e.stopImmediatePropagation();
            elems.forEach((item) => {
              item.elem.tooltip("close");
            });
            $(this).attr(
              "src",
              "http://s3.amazonaws.com/appforest_uf/f1628765173777x457896309616959500/Property%20Info.svg"
            );
            closeIfOpened(item.elem[0].id);
            item.elem.tooltip("open");
          });

          item.elem.tooltip({
            items: item.id,
            position: { my: "left-45% top", at: "left bottom+10" },
            content: `
      <div class="tooltip-container">
        ${item.content}
        <div class="close">
          <span>Ã—</span>
        </div>
      </div>`,
          });

          item.elem.on("click", function (e) {
            item.elem.tooltip("open");
          });

          item.elem.on("mouseleave", function (e) {
            e.stopImmediatePropagation();
            $(this).attr(
              "src",
              "http://s3.amazonaws.com/appforest_uf/f1663766856939x122820179078912510/Icon_I%20%281%29.svg"
            );
          });

          $(document).mouseup(function (e) {
            const container = $(".ui-tooltip");
            if (
              !container.is(e.target) &&
              container.has(e.target).length !== 0 &&
              e.target.parentElement.className === "close"
            ) {
              item.elem.tooltip("close");
            }
          });
        });
        return elems;
      }
    </script>

    <script>
      let savedTooltips = [];
      (function createChartDoughnut(id) {
        const CHART_COLORS = ["#66A3D2", "#FFC373", "#7272D5", "#7FDBB3"];
        const CHART_TITLE = [
          "Appreciation",
          "Debt Paydown",
          "Cash Flow",
          "Depreciation",
        ];
        const appreciation = 7000;
        const debtPaydown = 8000;
        const cashflow = 9000;
        const depreciation = 5000;
        const DATA_COUNT = [appreciation, debtPaydown, cashflow, depreciation];
        let isCountPercent = false;
        let TOTAL_COUNT = (
          appreciation +
          debtPaydown +
          cashflow +
          depreciation
        ).toFixed();

        const replaceNumber = (text) => {
          const pattern = /\B(?=(\d{3})+(?!\d))/g;
          return text.toString().replace(pattern, ",");
        };

        const dataPars = (dataCount) => {
          const dataPercent = [];
          dataCount.map((item) => {
            dataPercent.push(Number(((item * 100) / 300000).toFixed(1)));
          });
          return dataPercent;
        };

        const reducer = (accumulator, currentValue) =>
          accumulator + currentValue;

        let SUM_COUNT_PERCENT = dataPars(DATA_COUNT).reduce(reducer).toFixed(1);

        const sortedPercent = dataPars(DATA_COUNT).sort((a, b) => b - a);
        const BOT_RANGE = 50;
        const DISPERSION = 30;
        const maxVal = sortedPercent[0];

        const thicknessData = sortedPercent.map((item) => {
          let value;
          if (item === maxVal) {
            value = DISPERSION;
          } else {
            value = (item * DISPERSION) / maxVal;
          }
          return [BOT_RANGE, BOT_RANGE + value];
        });

        const getLegendList = (chart, id) => {
          let legendContainer = document.getElementById(id);
          let listContainer = legendContainer?.querySelector("ul");
          if (!listContainer) {
            listContainer = document.createElement("ul");
            listContainer.style.display = "flex";
            listContainer.style.margin = 0;
            listContainer.style.padding = 0;
            legendContainer.appendChild(listContainer);
          }
          return listContainer;
        };

        const htmlLegendPlugin = {
          id: "htmlLegend",
          afterUpdate(chart, args, options) {
            const ul = getLegendList(chart, options.containerID);
            // Remove old legend items
            while (ul.firstChild) {
              ul.firstChild.remove();
            }
            // Reuse the built-in legendItems generator
            const items =
              chart.options.plugins.legend.labels.generateLabels(chart);

            items.forEach((item, index = 0) => {
              const toopTip = document.createElement("img");
              toopTip.className = "tooltip";
              toopTip.src =
                "http://s3.amazonaws.com/appforest_uf/f1663766856939x122820179078912510/Icon_I%20%281%29.svg";
              toopTip.alt = "";
              toopTip.id = `tt${index + 1}`;
              const li = document.createElement("li");
              li.onclick = (e) => {
                if (
                  chart.config.type !== "doughnut" ||
                  e.target.className === "tooltip"
                )
                  return;
                const isVisible = chart.getDataVisibility(item.index);
                if (isVisible) {
                  SUM_COUNT_PERCENT = (
                    SUM_COUNT_PERCENT -
                    ((DATA_COUNT[index] * 100) / 300000).toFixed(1)
                  ).toFixed(1);

                  TOTAL_COUNT -= DATA_COUNT[index];
                } else {
                  SUM_COUNT_PERCENT =
                    +SUM_COUNT_PERCENT +
                    +((DATA_COUNT[index] * 100) / 300000).toFixed(1);

                  TOTAL_COUNT += +DATA_COUNT[index];
                }

                chart.toggleDataVisibility(item.index);
                const sumTextCenter =
                  document.querySelector(".sum-text-center");
                sumTextCenter.innerText = `${
                  isCountPercent
                    ? SUM_COUNT_PERCENT + " %"
                    : "$" + replaceNumber(TOTAL_COUNT)
                }`;
                savedTooltips?.forEach((item) => item.elem.tooltip("close"));
                chart.update();
                savedTooltips = initTooltips();
              };
              // Color box
              const boxSpan = document.createElement("span");
              boxSpan.style.background = item.fillStyle;
              boxSpan.style.borderColor = item.strokeStyle;
              boxSpan.style.borderWidth = item.lineWidth + "px";
              // Text
              const textContainer = document.createElement("p");
              textContainer.style.color = item.fontColor;
              textContainer.style.margin = 0;
              textContainer.style.padding = 0;
              textContainer.style.textDecoration = item.hidden
                ? "line-through"
                : "";
              const text = document.createTextNode(item.text);
              textContainer.appendChild(text);

              const valueContainer = document.createElement("p");
              valueContainer.style.color = item.fontColor;
              valueContainer.style.margin = 0;
              valueContainer.style.padding = 0;
              valueContainer.style.textDecoration = item.hidden
                ? "line-through"
                : "";
              const value = document.createTextNode(
                isCountPercent
                  ? `${dataPars(DATA_COUNT)[index]} %`
                  : `$ ${replaceNumber(DATA_COUNT[index])}`
              );
              valueContainer.appendChild(value);
              li.appendChild(boxSpan);
              li.appendChild(textContainer);
              li.appendChild(toopTip);
              li.appendChild(valueContainer);
              ul.appendChild(li);
            });
          },
        };

        const thickness = {
          id: "thickness",
          beforeDraw: (chart, options) => {
            let thickness = chart.options.plugins.thickness.thickness;
            chart.getDatasetMeta(0).data[0].innerRadius = 47.21;
            chart.getDatasetMeta(0).data[0].outerRadius = 82.83;
            chart.getDatasetMeta(0).data[1].innerRadius = 47.21;
            chart.getDatasetMeta(0).data[1].outerRadius = 77.59;
            chart.getDatasetMeta(0).data[2].innerRadius = 47.21;
            chart.getDatasetMeta(0).data[2].outerRadius = 72.59;
            chart.getDatasetMeta(0).data[3].innerRadius = 47.21;
            chart.getDatasetMeta(0).data[3].outerRadius = 66.1;
          },
        };

        const createLabelTitle = () => {
          const titleArr = [];
          if (isCountPercent) {
            dataPars(DATA_COUNT).map((item, index) => {
              titleArr.push(`${CHART_TITLE[index]}`);
            });
          } else {
            DATA_COUNT.map((item, index) => {
              titleArr.push(`${CHART_TITLE[index]}`);
            });
          }
          return titleArr;
        };

        const data = {
          datasets: [
            {
              data: dataPars(DATA_COUNT),
              backgroundColor: CHART_COLORS,
            },
          ],
          labels: createLabelTitle(),
        };

        const options = {
          responsive: false,
          maintainAspectRatio: false,
          layout: {
            padding: {
              left: 0,
              right: 0,
            },
          },
          plugins: {
            htmlLegend: {
              containerID: "legend-container",
            },
            legend: {
              onClick() {},
              display: false,
              position: "bottom",
              align: "start",
              maxWidth: 150,
              labels: {
                boxWidth: 15,
                boxHeight: 15,
              },
            },
            thickness: {
              thickness: thicknessData,
            },
            legend: {
              position: "bottom",
              display: false,
            },
            title: {
              display: false,
              text: "Chart.js Doughnut Chart",
            },
            animation: {
              animateScale: true,
              animateRotate: true,
            },
          },
        };

        const config = {
          type: "doughnut",
          data: data,
          plugins: [thickness, htmlLegendPlugin],
          options: options,
        };

        const canvasWrap = document.querySelector(".chart-wrapper");
        const chart = document.createElement("canvas");
        canvasWrap.appendChild(chart);
        const chartId = `chart-${id}`;
        chart.id = chartId;
        const ctx = document.getElementById(chartId);
        const myChartmb = new Chart(ctx, config);

        const sumTextCenter = document.querySelector(".sum-text-center");
        sumTextCenter.innerText = `${
          isCountPercent
            ? SUM_COUNT_PERCENT + " %"
            : "$" + replaceNumber(TOTAL_COUNT)
        }`;
        const elAnualType = document.querySelector(".current-annual-type");
        const toggleCountType = document.querySelector(".toggle-count-value");
        toggleCountType.addEventListener("click", () => {
          isCountPercent = !isCountPercent;
          myChartmb.data.labels = createLabelTitle();
          savedTooltips.forEach((item) => item.elem.tooltip("close"));
          myChartmb.update();
          savedTooltips = initTooltips();
          savedTooltips?.forEach((item) => item.elem.tooltip("close"));
          elAnualType.innerText = isCountPercent ? "Dollars" : "Percents";
          const sumTextCenter = document.querySelector(".sum-text-center");
          sumTextCenter.innerText = `${
            isCountPercent
              ? SUM_COUNT_PERCENT + " %"
              : "$" + replaceNumber(TOTAL_COUNT)
          }`;
        });
      })("test");
      savedTooltips = initTooltips();
      savedTooltips?.forEach((item) => item.elem.tooltip("close"));
    </script>
  </body>
</html>
