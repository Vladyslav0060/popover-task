<head>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600&family=Poppins:wght@400;500;600&display=swap"
    rel="stylesheet"
  />

  <link
    rel="stylesheet"
    href="//code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css"
  />
  <link rel="stylesheet" href="/resources/demos/style.css" />
  <script src="https://code.jquery.com/jquery-3.6.0.js"></script>
  <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<div class="wrapper">
  <div class="progress">
    <div class="goal-progress">
      <span class="goal-progress__current-sum" id="curr_sum0"></span>
      <span class="goal-progress__goal-sum" id="goal_sum0"></span>
    </div>
    <div class="ProgressBg0">
      <div class="bar" id="ProgressBarGreen0"></div>
      <div class="secondary-bar" id="ProgressBarBlue0"></div>
    </div>
    <div class="description-container">
      <p class="description-bar" id="desc-bar0" />
      <div class="description-container__popover" data-toggle="popover">
        <img
          src="http://s3.amazonaws.com/appforest_uf/f1663766856939x122820179078912510/Icon_I%20%281%29.svg"
          alt=""
          id="tt0"
        />
      </div>
    </div>
  </div>
  <div class="progress">
    <div class="goal-progress">
      <span class="goal-progress__current-sum" id="curr_sum1"></span>
      <span class="goal-progress__goal-sum" id="goal_sum1"></span>
    </div>
    <div class="ProgressBg0">
      <div class="bar" id="ProgressBarGreen1"></div>
      <div class="secondary-bar" id="ProgressBarBlue1"></div>
    </div>
    <div class="description-container">
      <p class="description-bar" id="desc-bar1" />
      <div class="description-container__popover" data-toggle="popover">
        <img
          src="http://s3.amazonaws.com/appforest_uf/f1663766856939x122820179078912510/Icon_I%20%281%29.svg"
          alt=""
          id="tt1"
        />
      </div>
    </div>
  </div>
  <div class="progress">
    <div class="goal-progress">
      <span class="goal-progress__current-sum" id="curr_sum2"></span>
      <span class="goal-progress__goal-sum" id="goal_sum2"></span>
    </div>
    <div class="ProgressBg0">
      <div class="bar" id="ProgressBarGreen2"></div>
      <div class="secondary-bar" id="ProgressBarBlue2"></div>
    </div>
    <div class="description-container">
      <p class="description-bar" id="desc-bar2" />
      <div class="description-container__popover" data-toggle="popover">
        <img
          src="http://s3.amazonaws.com/appforest_uf/f1663766856939x122820179078912510/Icon_I%20%281%29.svg"
          alt=""
          id="tt2"
        />
      </div>
    </div>
  </div>

  <div class="progress">
    <div class="goal-progress">
      <span class="goal-progress__current-sum" id="curr_sum3"></span>
      <span class="goal-progress__goal-sum" id="goal_sum3"></span>
    </div>
    <div class="ProgressBg0">
      <div class="bar" id="ProgressBarGreen3"></div>
      <div class="secondary-bar" id="ProgressBarBlue3"></div>
    </div>
    <div class="description-container">
      <p class="description-bar" id="desc-bar3" />
      <div class="description-container__popover" data-toggle="popover">
        <img
          src="http://s3.amazonaws.com/appforest_uf/f1663766856939x122820179078912510/Icon_I%20%281%29.svg"
          alt=""
          id="tt3"
        />
      </div>
    </div>
  </div>

  <button id="click">click to change data</button>
</div>

<style>
  .wrapper {
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  .progress {
    max-width: 477px;
  }

  .ProgressBg0 {
    display: flex;
    height: 8px;
    background: rgba(137, 138, 139, 0.3);
    border-radius: 30px;
    position: relative;
  }

  #ProgressBg0:after {
    content: "";
    display: block;
    width: 3px;
    height: 16px;
    border-radius: 20px;
    background-color: #898a8b;
    position: absolute;
    top: -4px;
    right: 82px;
  }

  .bar-info-tooltip {
    border: 1px solid grey !important;
  }

  .bar-info-tooltip .ui-tooltip-content {
    padding: 0 !important;
  }

  .bar {
    background: linear-gradient(180deg, #81deb5 0%, #65cea1 100%);
    border: 0.5px solid #ffffff;
    box-sizing: border-box;
    border-radius: 30px;
    height: 9px;
    width: 1%;
    text-align: center;
    line-height: 30px;
    color: white;
    position: relative;
  }

  .bar:after {
    content: "";
    display: block;
    width: 1px;
    height: 5px;
    background: #ffffff;
    border-radius: 20px;
    position: absolute;
    top: 1px;
    right: 16px;
    z-index: 1000;
  }

  .secondary-bar {
    background: linear-gradient(180deg, #0b61a4 0%, #3c8fd0 100%);
    border: 0.5px solid #ffffff;
    box-sizing: border-box;
    border-radius: 30px;
    height: 9px;
    text-align: center;
    line-height: 30px;
    color: white;
    position: relative;
  }

  .goal-progress {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 3px;
    padding: 0 40px;
  }

  .goal-progress .goal-progress__current-sum,
  .goal-progress__goal-sum {
    font-family: Montserrat;
    font-style: normal;
    font-weight: normal;
    font-size: 18px;
    line-height: 22px;
    letter-spacing: 0.025em;
    color: #08090d;
  }

  .description-container {
    display: flex;
    justify-content: end;
    align-items: center;
    gap: 6px;
    padding-right: 5px;
  }

  .description-container .popover .arrow {
    display: none;
  }
  .description-container .popover .close {
    width: 30px;
    height: 30px;
    background-color: blue;
  }
  .description-container__popover {
    width: 16px;
    padding-top: 5px;
  }

  .description-bar {
    font-family: Montserrat;
    font-style: normal;
    font-weight: 500;
    font-size: 16px;
    line-height: 20px;
    color: #898a8b;
    margin: 5px 0 0;
  }

  [role="tooltip"] {
    /* border: 1px solid rgba(11, 97, 164, 1); */
    box-shadow: none;
    border-radius: 5px;
    max-width: 400px;
  }

  .ui-widget.ui-widget-content {
    border: 1px solid rgba(11, 97, 164, 1);
  }

  [role="tooltip"] .ui-tooltip-content {
    padding: 15px 35px 15px 15px;
    font-family: "Montserrat", sans-serif;
    font-style: normal;
    font-weight: 400;
    font-size: 12px;
    line-height: 15px;
    letter-spacing: 0.025em;

    color: #3c3e40;
  }
  [role="tooltip"] .tooltip-container .close {
    display: flex;
    width: 16px;
    align-items: center;
    justify-content: center;
    height: 16px;
    position: absolute;
    text-align: center;
    color: white;
    border-radius: 50px;
    /* background: #0b61a4; */
    border: none;
    line-height: 16px;
    font-size: 10px;
    cursor: pointer;
    top: 6px;
    right: 13px;
    background-image: url("https://s3.amazonaws.com/appforest_uf/f1628768879842x219275027212698660/Close%20Property%20Info.svg");
    background-size: contain;
    background-repeat: no-repeat;
  }
</style>

<script>
  class Api {
    #amount;
    #termInMonths;
    #interestRate;
    #startingBalance;
    #additionalPayment;
    constructor(
      amount,
      termInMonths,
      interestRate,
      startingBalance,
      additionalPayment = 0
    ) {
      this.#amount = amount;
      this.#termInMonths = termInMonths;
      this.#interestRate = interestRate;
      this.#startingBalance = startingBalance;
      this.#additionalPayment = additionalPayment;
    }

    #roundNumber = (number) => Math.round(number * 100) / 100; // round to 2 digits

    #calculateAmortization = (
      balance,
      monthlyPayment,
      termInMonths,
      interestPerMonth,
      additionalPayment
    ) => {
      let amortization = [];
      let currentBalance = balance;
      let prevousBalance = 0;
      let totalInterest = 0;
      let totalPayment = 0;
      let toInterest = 0;
      let toPrincipal = 0;
      let currentMonth = 1;

      while (currentMonth < parseInt(termInMonths) + 1) {
        toInterest = this.#roundNumber(currentBalance * interestPerMonth);
        totalInterest = this.#roundNumber(totalInterest + toInterest);
        toPrincipal = monthlyPayment - toInterest + parseInt(additionalPayment);
        totalPayment = toPrincipal + toInterest;
        prevousBalance = currentBalance;
        currentBalance = this.#roundNumber(currentBalance - toPrincipal);

        if (currentBalance < 0) {
          totalPayment = prevousBalance + toInterest;
          toPrincipal = prevousBalance;
          currentBalance = 0;
        }

        amortization.push({
          month: currentMonth,
          principal: toPrincipal,
          totalPayment,
          interest: toInterest,
          totalInterest: totalInterest,
          balance: currentBalance,
        });
        if (currentBalance === 0) break;
        currentMonth++;
      }
      return { totalInterest: totalInterest, amortization: amortization };
    };
    #calculate = (amount, termInMonths, interestRate, additionalPayment) => {
      const interestPerMonth = interestRate / 100.0 / 12;
      const monthlyPayment = roundNumber(
        amount *
          (interestPerMonth +
            interestPerMonth /
              (Math.pow(1 + interestPerMonth, termInMonths) - 1))
      );

      const amortizationResult = calculateAmortization(
        amount,
        monthlyPayment,
        termInMonths,
        interestPerMonth,
        additionalPayment
      );
      const summary = {
        numberOfPayments: amortizationResult.amortization.length,
        monthlyPayment: monthlyPayment,
        interestPerMonth,
        totalInterest: amortizationResult.totalInterest,
        totalPrincipal: parseInt(amount),
        totalPayment: amortizationResult.totalInterest + parseInt(amount),
      };
      return { amortization: amortizationResult.amortization, summary };
    };
    #calculateWithStart = (
      amount,
      termInMonths,
      interestRate,
      additionalPayment,
      startingBalance
    ) => {
      const interestPerMonth = interestRate / 100.0 / 12;
      const monthlyPayment = this.#roundNumber(
        amount *
          (interestPerMonth +
            interestPerMonth /
              (Math.pow(1 + interestPerMonth, termInMonths) - 1))
      );
      const amortization = [];
      let currentBalance = amount;
      let prevousBalance = 0;
      let totalInterest = 0;
      let totalPayment = 0;
      let toInterest = 0;
      let toPrincipal = 0;
      let currentMonth = 1;
      let balance = startingBalance;
      while (startingBalance !== 0) {
        const difference = currentBalance - startingBalance;
        toInterest = this.#roundNumber(startingBalance * interestPerMonth);
        totalInterest = this.#roundNumber(totalInterest + toInterest);
        toPrincipal = monthlyPayment - toInterest + parseInt(additionalPayment);
        totalPayment = toPrincipal + toInterest;
        if (toPrincipal <= difference) {
          totalInterest = this.#roundNumber(totalInterest - toInterest);
          currentBalance -= toPrincipal;
          continue;
        }

        prevousBalance = startingBalance;
        startingBalance = this.#roundNumber(startingBalance - toPrincipal);
        if (startingBalance <= 0) {
          totalPayment = prevousBalance + toInterest;
          toPrincipal = prevousBalance;
          startingBalance = 0;
        }

        amortization.push({
          month: currentMonth,
          principal: toPrincipal,
          totalPayment,
          interest: toInterest,
          totalInterest: totalInterest,
          balance: startingBalance,
        });
        currentMonth++;
      }
      const summary = {
        numberOfPayments: amortization.length,
        monthlyPayment: monthlyPayment,
        interestPerMonth,
        totalInterest,
        totalPrincipal: parseInt(amount),
        totalPaymentsSB: totalInterest + parseFloat(balance),
        totalPaymentsAMT: totalInterest + parseFloat(amount),
      };
      return { amortization, summary };
    };
    calculateLoanAmortization = () => {
      return this.#calculateWithStart(
        this.#amount,
        this.#termInMonths,
        this.#interestRate,
        this.#additionalPayment,
        this.#startingBalance
      );
    };
  }

  const calculateOnSlider = (
    used_equity,
    down_payment,
    cap,
    interest,
    loan_payment_old,
    loan_balance_old
  ) => {
    const added_value = used_equity / down_payment;
    const added_noi = added_value * cap;
    const new_balance = added_value - used_equity;
    const loan_payment_new_investment = new Api(
      new_balance,
      360,
      interest * 100,
      new_balance
    ).calculateLoanAmortization().summary.monthlyPayment;

    const loan_payment_new_target = new Api(
      loan_balance_old + used_equity,
      360,
      interest * 100,
      loan_balance_old + used_equity
    ).calculateLoanAmortization().summary.monthlyPayment;

    const loan_payment_new_total =
      loan_payment_new_investment + loan_payment_new_target - loan_payment_old;

    const added_cashflow = added_noi - loan_payment_new_total;
    return { added_value, added_noi, added_cashflow };
  };
</script>

<script>
  const start = (progress_array) => {
    const id = "#tt0";
    const $elem = $(id);
    const id1 = "#tt1";
    const $elem1 = $(id1);
    const id2 = "#tt2";
    const $elem2 = $(id2);
    const id3 = "#tt3";
    const $elem3 = $(id3);

    let arr = [
      {
        id: "#tt0",
        item: $elem,
        text: "This is the content of a #tt0 tooltip",
      },
      {
        id: "#tt1",
        item: $elem1,
        text: "This is the content of a #tt1 tooltip",
      },
      {
        id: "#tt2",
        item: $elem2,
        text: "This is the content of a #tt2 tooltip",
      },
      {
        id: "#tt3",
        item: $elem3,
        text: "This is the content of a #tt3 tooltip",
      },
    ];

    $(function () {
      $(".bar").tooltip({
        tooltipClass: "bar-info-tooltip",
      });
      $(".secondary-bar").tooltip({
        tooltipClass: "bar-info-tooltip",
      });
    });

    const close_all_tooptips = () =>
      arr.forEach((arrItem) => arrItem.item.tooltip("close"));

    arr.forEach(({ id, item, text } = el) => {
      item.on("mouseenter", function (e) {
        e.stopImmediatePropagation();
        // $(this).attr(
        //   "src",
        //   "http://s3.amazonaws.com/appforest_uf/f1628765173777x457896309616959500/Property%20Info.svg"
        // );
        close_all_tooptips();
        item.tooltip("open");
      });

      item.tooltip({
        items: id,
        // content: `<div class="tooltip-container">${text}<div class="close" /></div>`,
        content: `<div class="tooltip-container">${text}</div>`,
      });

      item.on("click", function (e) {
        item.tooltip("open");
      });

      item.on("mouseleave", function (e) {
        e.stopImmediatePropagation();
        item.tooltip("close");
        // $(this).attr(
        //   "src",
        //   "http://s3.amazonaws.com/appforest_uf/f1663766856939x122820179078912510/Icon_I%20%281%29.svg"
        // );
      });

      $(document).mouseup(function (e) {
        const container = $(".ui-tooltip");
        if (
          !container.is(e.target) &&
          container.has(e.target).length !== 0 &&
          e.target.className === "close"
        ) {
          item.tooltip("close");
        }
      });
    });

    const replaceNumber = (text) => {
      const pattern = /\B(?=(\d{3})+(?!\d))/g;
      return text.toString().replace(pattern, ",");
    };

    progress_array.forEach((progress_bar, index = 0) => {
      const [CURRENT_SUM, GOAL_SUM, BLUE_SUM, DESCRIPTION_BAR] =
        Object.values(progress_bar);
      const ElCurrentSum = document.getElementById(`curr_sum${index}`);
      ElCurrentSum.textContent = "$ " + replaceNumber(CURRENT_SUM + BLUE_SUM);
      const ElGoalSum = document.getElementById(`goal_sum${index}`);
      ElGoalSum.textContent = "$ " + replaceNumber(GOAL_SUM);
      const ElDescriptionBar = document.getElementById(`desc-bar${index}`);
      ElDescriptionBar.textContent = DESCRIPTION_BAR;

      let i = 0;
      const move = () => {
        let goalSumPercent = ((CURRENT_SUM * 83) / GOAL_SUM).toFixed();
        let goalSumPercent1 = ((BLUE_SUM * 83) / GOAL_SUM).toFixed();
        if (i === 0) {
          i = 1;
          const progressBar = document.getElementById(
            `ProgressBarGreen${index}`
          );
          const progressBar1 = document.getElementById(
            `ProgressBarBlue${index}`
          );
          progressBar.style = null;
          progressBar1.style = null;
          progressBar.title = "$ " + replaceNumber(CURRENT_SUM);
          progressBar1.title = "$ " + replaceNumber(BLUE_SUM);
          progressBar1.style.position = "absolute";
          if (BLUE_SUM > 0)
            progressBar1.style.maxWidth = 101 - goalSumPercent + "%";
          BLUE_SUM < 0
            ? (progressBar1.style.left =
                goalSumPercent - Math.abs(goalSumPercent1) > 0
                  ? goalSumPercent - Math.abs(goalSumPercent1) + "%"
                  : 0 + "%")
            : (progressBar1.style.right =
                100 - goalSumPercent1 - Math.abs(goalSumPercent) > 0
                  ? 100 - goalSumPercent1 - Math.abs(goalSumPercent) + "%"
                  : 0 + "%");
          let width = 0;
          let width1 = 0;
          if (CURRENT_SUM + BLUE_SUM <= 0) {
            progressBar.style.display = "none";
            progressBar1.style.display = "none";
          }
          if (CURRENT_SUM < 0) {
            progressBar.style.display = "none";
            progressBar1.style.left = 0;
          }
          if (goalSumPercent >= 100) goalSumPercent = 100;
          if (
            (BLUE_SUM < 100 && BLUE_SUM >= 0) ||
            ((Math.abs(BLUE_SUM) / 83) * 100 <
              (Math.abs(GOAL_SUM) / 83) * 100 &&
              BLUE_SUM >= 0 &&
              CURRENT_SUM >= (GOAL_SUM / 83) * 100)
          )
            progressBar1.style.display = "none";
          if (BLUE_SUM < 0) {
            progressBar1.style.background = "red";
          }
          const id = setInterval(() => {
            if (GOAL_SUM / BLUE_SUM > 9.76) ++width1;
            if (
              width >= goalSumPercent &&
              width1 >= Math.abs(goalSumPercent1)
            ) {
              clearInterval(id);
              i = 0;
            } else if (width <= goalSumPercent) {
              width++;
              progressBar.style.minWidth = width + "%";
            }
            if (width1 < Math.abs(goalSumPercent1)) {
              if (
                BLUE_SUM < 0 &&
                Math.abs(BLUE_SUM) > Math.abs(CURRENT_SUM) &&
                width1 >= goalSumPercent
              )
                return;
              ++width1;
              progressBar1.style.width = ++width1 + "%";
            }
          }, 1);
        }
      };
      move();
    });
  };
  let progress_array = [
    {
      CURRENT_SUM: 100000,
      GOAL_SUM: 1000000,
      BLUE_SUM: 500000,
      DESCRIPTION_BAR: "RE Valuation Goal",
    },
    {
      CURRENT_SUM: 400000,
      GOAL_SUM: 750000,
      BLUE_SUM: 750000,
      DESCRIPTION_BAR: "RE Valuation Goal",
    },
    {
      CURRENT_SUM: 7500000,
      GOAL_SUM: 750000,
      BLUE_SUM: 100000,
      DESCRIPTION_BAR: "RE Valuation Goal",
    },
    {
      CURRENT_SUM: -50000,
      GOAL_SUM: 750000,
      BLUE_SUM: 100000,
      DESCRIPTION_BAR: "RE Valuation Goal",
    },
  ];

  const button = document.getElementById("click");
  button.addEventListener("click", () => {
    const { added_value, added_noi, added_cashflow } = calculateOnSlider(
      100000,
      0.35,
      0.05,
      0.07,
      6000,
      50000
    );

    progress_array[0].BLUE_SUM = added_value;
    progress_array[1].BLUE_SUM = added_noi;
    progress_array[3].BLUE_SUM = added_cashflow;

    start(progress_array);
  });
  start(progress_array);
</script>
